# 🤖 caropii RAGシステム設計記録

## 📋 設計決定事項（2025年7月24日）

### 🎯 基本方針
**「AIに全部任せる」アプローチを採用**
- 複雑なプログラムロジック → シンプルなAI指示に置き換え
- 開発時間短縮 + バグ減少 + コスト削減を実現

### 🏗️ システム構成

#### 処理フロー
```
音声/テキスト入力 
    ↓
Rails API（食材データベース情報を取得）
    ↓  
Gemini API（食材DB情報付きプロンプトで一発処理）
    ↓
計算済み結果をiOSに返却
```

#### データの流れ
1. **ユーザー入力**: "今日は鮭おにぎり2個とサラダチキン食べました"
2. **Rails処理**: foodsテーブルから全食材情報を取得
3. **Gemini処理**: 食材識別 + 重量推定 + 栄養計算 + 既知/未知判定
4. **結果返却**: 計算済みの栄養価データをJSON形式で返す

### 🤖 AIが担当する処理内容

#### 1. 食材識別・抽出
- 自然言語から食材名を正確に抽出
- 表記揺れの自動修正（"サラダちきん" → "サラダチキン"）

#### 2. 重量・量の推定と計算
```
例：「鮭おにぎり2個」の場合
- 一般的なおにぎり1個 = 約80gと推定
- 2個なら160g分として栄養価を計算
- 計算過程も含めてレスポンス
```

#### 3. 既知/未知食材の判定
- データベース照合による既知食材の特定
- 未知食材の栄養価推定
- 両方を統合した結果を返却

#### 4. 結果の構造化
```json
{
  "foods": [
    {
      "name": "鮭おにぎり",
      "quantity": "2個", 
      "estimated_weight": "80g×2個=160g",
      "calculation": "1個推定150kcal×2=300kcal",
      "final_nutrition": {
        "calories": 300,
        "protein": 12,
        "fat": 4,
        "carbs": 58
      },
      "known": false
    }
  ]
}
```

### 💰 コスト最適化戦略

#### トークン課金の理解
- **課金対象**: プロンプト文字数 + レスポンス文字数のみ
- **無料**: AIの処理時間・計算量・電力消費
- **戦略**: 複雑な計算をAIにやらせても追加コストなし

#### 段階的データ投入（将来実装）
```
基本モード: 軽量プロンプト（食材DBのみ）
詳細分析モード: 過去データ + Apple Watchデータ追加
```

### 📱 UI/UX設計

#### 入力方式の共存
1. **タップ選択**: 既存機能をそのまま維持
2. **テキスト入力**: ChatGPT風の入力フィールド
3. **音声入力**: iOS標準Speech Framework使用

#### 未知食材の確認フロー
1. **確認画面表示**: 未知食材の推定栄養価を表示
2. **チェックボックス選択**: 保存する/しないを個別選択
3. **一括処理**: 選択したもののみデータベースに保存

### 🛠️ 実装詳細

#### Rails側の追加実装
```ruby
# app/controllers/natural_language_controller.rb
class NaturalLanguageController < ApplicationController
  def process_food_input
    # 1. 食材マスタ取得
    food_list = Food.pluck(:name, :calories, :protein, :fat, :carbs)
    
    # 2. 拡張プロンプト生成
    prompt = build_enhanced_prompt(params[:text], food_list)
    
    # 3. Gemini API呼び出し
    result = call_gemini_api(prompt)
    
    # 4. 結果返却
    render json: result
  end
  
  private
  
  def build_enhanced_prompt(user_text, foods)
    # 食材データベース情報 + 計算指示 + ユーザー入力を統合
  end
end
```

#### プロンプト設計例
```
【利用可能な食材データベース（100g基準）】
- 鶏胸肉: 108kcal, タンパク質23g, 脂質1.5g, 炭水化物0g
- サラダチキン: 100kcal, タンパク質20g, 脂質2g, 炭水化物1g
...

【ユーザー入力】
今日は鮭おにぎり2個とサラダチキン食べました

【処理指示】
1. 食材を識別し、データベース照合
2. 一般的な1個/1人前の重量を推定  
3. 栄養価を計算（重量×個数）
4. 計算過程も含めてJSON形式で返答
```

### 🎖️ 就活アピールポイント

#### 技術的工夫
- **コスト最適化**: トークン効率を考慮したRAG設計
- **AI活用**: 複雑なビジネスロジックをAIに委譲
- **拡張性**: 将来的なデータ増加に対応した設計

#### 開発効率
- **開発時間短縮**: 複雑な計算ロジック実装が不要
- **バグ減少**: AIによる自然言語処理でエラーハンドリング簡素化
- **メンテナンス性**: プロンプト調整で機能改善が可能

### 🔮 将来の拡張計画

#### Apple Watchデータ統合時
```
基本プロンプト + 睡眠データ + 運動データ → 総合健康分析
```

#### 大量データ対応
- ベクトル検索による関連情報の絞り込み
- データ圧縮による トークン削減
- キャッシュ機能による API呼び出し最適化

---

## 📝 実装優先順位

1. **Phase 1**: 基本的な自然言語食材入力機能
2. **Phase 2**: 未知食材の確認・保存機能  
3. **Phase 3**: Apple Watchデータ統合
4. **Phase 4**: コスト最適化機能

---

**記録日**: 2025年7月24日  
**設計者**: natatekoko + Claude Code