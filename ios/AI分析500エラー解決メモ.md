# AI分析500エラー解決メモ

## 現在の状況
- **問題**: FoodLogScreenでAI分析ボタンを押すと500 Internal Server Errorが発生
- **原因**: 本番環境（Render）でGEMINI_API_KEYが設定されていない
- **URL**: https://caropii.onrender.com

## これまでの経緯

### 1. 最初の問題
- FoodLogScreenにAI分析機能がなかった
- SaveViewDebugには存在していたが、ファイルが見つからない

### 2. 実装した内容
```swift
// FoodLogScreenに追加したコード
// AI分析用の状態変数
@State private var isAnalyzing = false
@State private var showingAnalysisResult = false
@State private var showingEmptyAnalysisAlert = false
@State private var analysisText: String = ""

// AI分析ボタン（紫色）
Button(action: {
    if !isAnalyzing {
        analyzeWithAI()
    }
}) {
    HStack {
        if isAnalyzing {
            ProgressView()
        } else {
            Image(systemName: "brain")
        }
        Text(isAnalyzing ? "分析中..." : "AI分析")
    }
}
```

### 3. データ蓄積問題への対処
- 「牛乳しか選んでないのにサラダチキンも分析される」問題
- clear_todayエンドポイントを追加しようとした（不要だった）
- 最終的にclear_today関連のコードは全て削除

### 4. 型の違い
- SaveViewDebug: `[(String, String, Int)]` - 文字列型
- FoodLogScreen: `[(Food, String, Int)]` - Foodオブジェクト型
- PFC計算がFoodStoreの正確なデータを使用するように修正済み

## 現在のファイル構成
- `/ios/pfcz/FoodLogScreen.swift` - AI分析機能実装済み
- `/ios/pfcz/APIService.swift` - clear_todayメソッド削除済み
- `/ios/pfcz/AnalysisResultView.swift` - 分析結果表示用
- `/backend/app/services/health_analyzer.rb` - Gemini API使用

## 解決方法

### Renderで環境変数を設定
1. https://dashboard.render.com にアクセス
2. caropiiサービスを選択
3. Environment → Environment Variables
4. 以下を追加：
   - Key: `GEMINI_API_KEY`
   - Value: （Gemini APIキー）
5. Save Changes
6. Manual Deploy → Deploy latest commit

## 確認済みの事項
- ✅ AI分析ボタンの実装
- ✅ 分析中の多重実行防止（ボタン無効化）
- ✅ ローディング表示
- ✅ 空の食材リストでのアラート表示
- ✅ APIService.shared.getAIAnalysisの実装
- ✅ 本番環境URL（https://caropii.onrender.com）の使用

## 未解決の問題
- ❌ GEMINI_API_KEYが本番環境に設定されていない（500エラーの原因）

## コミット履歴
- `5709bd8 とりあえず`
- `c76bde7 試し`
- `a744ab1 Add clear_today endpoint for AI analysis` （不要だった）
- `b0d7af6 完了`
- `6df7065 栄養データ計算修正`

## 次のステップ
1. Mac再起動後、RenderダッシュボードでGEMINI_API_KEYを設定
2. Manual Deployで最新版をデプロイ
3. FoodLogScreenでAI分析をテスト
4. 動作確認できたらコミット

## 注意事項
- ローカル環境は使用しない（本番環境のみ）
- clear_todayエンドポイントは不要（元のUIでも使っていなかった）
- Railsサーバーのコードは変更不要