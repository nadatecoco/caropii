# 開発議事録：カロピー筋トレ機能実装 総合まとめ

## 日時
2025-08-07

## プロジェクト概要
カロピー（caropii）- 栄養管理アプリに筋トレ記録機能を追加実装

## 本日の実装内容

### 1. ツールバー機能の実装と撤回
#### 実装試行内容
- ExerciseDetailViewに定規型ピッカーを実装
  - 重量：0.5kg刻み、回数：1回刻み
  - キーボード上部に表示
  - 左右矢印ボタンで微調整機能

#### 問題点
- 複数セット間でツールバーが競合
- AutoLayout制約エラー発生
- 4セット目で特に顕著なバグ

#### 結果
- 時間的制約により実装を撤回
- 元の安定した状態に戻す決定

### 2. 永続保存機能の実装 ✅
#### 実装内容
- **JSON形式での保存**
  - Documents/WorkoutRecords/に日付ごとのファイル保存
  - 例：`2024-01-15.json`
  
- **データモデル設計**
  ```swift
  WorkoutDayRecord（1日分の記録）
  ├── ExerciseRecord（種目ごと）
  │   └── SetRecord（セットごと）
  │       ├── weight: Double
  │       ├── reps: Int
  │       ├── memo: String
  │       ├── isCompleted: Bool
  │       └── timestamp: Date? // 後から追加
  ```

- **日付区切り機能**
  - デフォルト：0時で区切り
  - 将来的にユーザー設定可能な設計

- **LLM送信用圧縮関数**
  ```
  通常：{"exerciseName": "ベンチプレス", "sets": [...]}
  圧縮：20240115:BP-60x10,60x8,65x6
  ```

#### 重要な設計決定
- 保存は人間が読みやすい形式で行う
- LLM送信時のみ圧縮変換
- 各セットの保存時刻も記録（セット間休憩時間の分析用）

### 3. カスタム種目の追加・削除機能 ✅
#### 実装場所
- ホーム → データを管理 → 筋トレ種目の管理

#### 機能詳細
1. **種目の追加** - ➕ボタンから新規追加
2. **種目の編集** - タップして直接名前編集
3. **種目の削除** - 左スワイプで削除ボタン表示
4. **並び替え** - ドラッグ&ドロップで順序変更

#### UI実装
- Listではなく**LazyVStack**使用（自由度向上）
- カスタムドラッグ&ドロップ実装
- スワイプ削除のカスタム実装
- ドラッグ後の表示バグも修正済み

#### データ保存
- UserDefaultsで永続化
- キー：`customExercises`

## 現在の実装状況

### ✅ 完成している機能
1. **基本的な筋トレ記録**
   - 3画面構成（一覧→種目選択→詳細入力）
   - 自動保存機能
   - kg/lbs単位切り替え
   - セットごとのメモ機能

2. **データ永続化**
   - JSON形式での保存
   - 日付ごとのファイル管理
   - アプリ再起動後もデータ保持

3. **カスタム種目管理**
   - 追加・編集・削除・並び替え
   - デフォルト8種目 + カスタム種目

### ❌ 未実装の機能
1. **過去の記録閲覧**
   - カレンダー表示 or 履歴一覧
   - 月間/週間の統計

2. **設定画面**
   - 日付区切り時間の変更
   - その他のカスタマイズ

3. **統計・グラフ機能**
   - トレーニングボリュームの推移
   - 1RMの計算と表示

4. **ツールバー機能**
   - 重量・回数の定規型入力
   - 技術的課題により保留

## ファイル構成
```
pfcz/
├── Models/
│   └── WorkoutModels.swift        # データモデル定義
├── Services/
│   └── WorkoutStorageService.swift # JSON保存サービス
├── WorkoutDataManager.swift       # データ管理クラス
├── WorkoutRecordView.swift        # 記録一覧画面
├── ExerciseSelectionView.swift    # 種目選択画面
├── ExerciseDetailView.swift       # 詳細入力画面
├── ExerciseManagementView.swift   # 種目管理画面
└── DataManagementView.swift       # データ管理メニュー
```

## 技術的なポイント

### 1. SwiftUIの活用
- @EnvironmentObject でデータ共有
- @FocusState でキーボード管理
- カスタムドラッグ&ドロップ実装

### 2. データ設計
- 将来の拡張を考慮（睡眠・食事データとの統合）
- LLM連携を前提とした圧縮関数
- 既存データとの互換性（Optional使用）

### 3. UX設計
- 保存ボタンなしの自動保存
- 前セットの重量を初期値として使用
- スワイプとタップの直感的な操作

## 今後の開発予定
1. 過去の記録閲覧機能
2. 統計・グラフ表示
3. 設定画面の実装
4. Apple Watch連携
5. 他のデータ（睡眠・食事）との統合分析

## 備考
- Gemini APIの利用制限（50リクエスト/日）に注意
- ツールバー機能は技術的課題が解決次第、再実装予定
- 基本機能の安定性を優先した開発方針

---
以上が本日の実装内容です。基本的な筋トレ記録機能は完成し、永続保存とカスタム種目管理も実装完了しました。